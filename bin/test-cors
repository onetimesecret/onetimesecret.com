#!/usr/bin/env bash
#
# test-cors - CORS Configuration Testing Tool
#
# Tests CORS headers on API endpoints by sending preflight OPTIONS requests
# and actual requests with different origins.
#
# Usage:
#   test-cors <api-endpoint> <origin> [method]
#   test-cors --batch <api-endpoint> <origin1> <origin2> ...
#   test-cors --full
#
# Examples:
#   # Test single origin
#   test-cors https://eu.onetimesecret.com/api/v2/secret/conceal https://onetimesecret.com
#
#   # Test with specific HTTP method
#   test-cors https://eu.onetimesecret.com/api/v2/secret/conceal https://onetimesecret.com POST
#
#   # Batch test multiple origins
#   test-cors --batch https://eu.onetimesecret.com/api/v2/secret/conceal \
#     https://onetimesecret.com \
#     https://www.onetimesecret.com \
#     http://localhost:4321
#
#   # Run full test suite (all regions, all origins)
#   test-cors --full
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Default values
DEFAULT_METHOD="POST"
DEFAULT_TIMEOUT=10

# CORS headers to check
CORS_HEADERS=(
  "access-control-allow-origin"
  "access-control-allow-methods"
  "access-control-allow-headers"
  "access-control-allow-credentials"
  "access-control-max-age"
)

# Function to print usage
usage() {
  cat << EOF
${BOLD}CORS Configuration Testing Tool${NC}

${BOLD}USAGE:${NC}
  test-cors <api-endpoint> <origin> [method]
  test-cors --batch <api-endpoint> <origin1> <origin2> ...
  test-cors --full
  test-cors --help

${BOLD}ARGUMENTS:${NC}
  api-endpoint    Full URL of the API endpoint to test
  origin          Origin URL to test from (e.g., https://example.com)
  method          HTTP method to test (default: POST)

${BOLD}OPTIONS:${NC}
  --batch         Test multiple origins against one endpoint
  --full          Run complete test suite (all regions, all origins)
  --help, -h      Show this help message

${BOLD}EXAMPLES:${NC}
  # Test single origin
  test-cors https://eu.onetimesecret.com/api/v2/secret/conceal https://onetimesecret.com

  # Test with specific HTTP method
  test-cors https://eu.onetimesecret.com/api/v2/secret/conceal https://onetimesecret.com POST

  # Batch test multiple origins
  test-cors --batch https://eu.onetimesecret.com/api/v2/secret/conceal \\
    https://onetimesecret.com \\
    https://www.onetimesecret.com \\
    http://localhost:4321

  # Run full test suite
  test-cors --full

${BOLD}OUTPUT:${NC}
  ${GREEN}✓${NC} CORS headers present and valid
  ${RED}✗${NC} CORS headers missing or invalid
  ${YELLOW}⚠${NC} Partial CORS configuration

EOF
  exit 0
}

# Function to print colored output
print_header() {
  echo -e "\n${BOLD}${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${BOLD}${CYAN}$1${NC}"
  echo -e "${BOLD}${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

print_subheader() {
  echo -e "\n${BOLD}$1${NC}"
}

print_success() {
  echo -e "${GREEN}✓${NC} $1"
}

print_error() {
  echo -e "${RED}✗${NC} $1"
}

print_warning() {
  echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
  echo -e "${BLUE}ℹ${NC} $1"
}

# Function to extract headers from curl output
extract_header() {
  local response="$1"
  local header_name="$2"
  echo "$response" | grep -i "^${header_name}:" | cut -d: -f2- | sed 's/^[[:space:]]*//' | tr -d '\r\n'
}

# Function to test CORS preflight
test_cors_preflight() {
  local endpoint="$1"
  local origin="$2"
  local method="${3:-$DEFAULT_METHOD}"

  print_header "CORS Preflight Test"
  print_info "Endpoint: ${BOLD}${endpoint}${NC}"
  print_info "Origin: ${BOLD}${origin}${NC}"
  print_info "Method: ${BOLD}${method}${NC}"

  # Make OPTIONS request
  print_subheader "Sending OPTIONS request..."

  local response
  response=$(curl -i -X OPTIONS "$endpoint" \
    -H "Origin: ${origin}" \
    -H "Access-Control-Request-Method: ${method}" \
    -H "Access-Control-Request-Headers: Content-Type" \
    --max-time "$DEFAULT_TIMEOUT" \
    --silent \
    2>&1) || {
    print_error "Failed to connect to endpoint"
    return 1
  }

  # Extract status code
  local status_code
  status_code=$(echo "$response" | grep -E "^HTTP/[0-9.]+ [0-9]+" | tail -1 | awk '{print $2}')

  print_subheader "Response Status: ${status_code}"

  # Check for CORS headers
  local cors_found=0
  local cors_missing=0

  print_subheader "CORS Headers:"

  for header in "${CORS_HEADERS[@]}"; do
    local value
    value=$(extract_header "$response" "$header")

    if [ -n "$value" ]; then
      print_success "${header}: ${value}"
      ((cors_found++))
    else
      print_error "${header}: ${RED}[MISSING]${NC}"
      ((cors_missing++))
    fi
  done

  # Summary
  echo ""
  if [ "$cors_missing" -eq 0 ]; then
    print_success "${BOLD}CORS is properly configured${NC}"
    return 0
  elif [ "$cors_found" -eq 0 ]; then
    print_error "${BOLD}CORS is NOT configured - no headers found${NC}"
    return 1
  else
    print_warning "${BOLD}Partial CORS configuration - some headers missing${NC}"
    return 1
  fi
}

# Function to test actual request
test_cors_request() {
  local endpoint="$1"
  local origin="$2"
  local method="${3:-$DEFAULT_METHOD}"

  print_header "CORS Actual Request Test"
  print_info "Endpoint: ${BOLD}${endpoint}${NC}"
  print_info "Origin: ${BOLD}${origin}${NC}"
  print_info "Method: ${BOLD}${method}${NC}"

  # Prepare request body for POST
  local body='{"secret":{"secret":"test","ttl":604800,"passphrase":null}}'

  print_subheader "Sending ${method} request..."

  local response
  if [ "$method" == "POST" ]; then
    response=$(curl -i -X POST "$endpoint" \
      -H "Origin: ${origin}" \
      -H "Content-Type: application/json" \
      -d "$body" \
      --max-time "$DEFAULT_TIMEOUT" \
      --silent \
      2>&1) || {
      print_error "Failed to connect to endpoint"
      return 1
    }
  else
    response=$(curl -i -X "$method" "$endpoint" \
      -H "Origin: ${origin}" \
      --max-time "$DEFAULT_TIMEOUT" \
      --silent \
      2>&1) || {
      print_error "Failed to connect to endpoint"
      return 1
    }
  fi

  # Extract status code
  local status_code
  status_code=$(echo "$response" | grep -E "^HTTP/[0-9.]+ [0-9]+" | tail -1 | awk '{print $2}')

  print_subheader "Response Status: ${status_code}"

  # Check for CORS headers in response
  local allow_origin
  allow_origin=$(extract_header "$response" "access-control-allow-origin")

  if [ -n "$allow_origin" ]; then
    print_success "CORS header present: ${allow_origin}"
    return 0
  else
    print_error "CORS header missing in response"
    return 1
  fi
}

# Function to run batch tests
run_batch_test() {
  local endpoint="$1"
  shift
  local origins=("$@")

  print_header "Batch CORS Testing"
  print_info "Testing ${#origins[@]} origins against: ${endpoint}"

  local passed=0
  local failed=0

  for origin in "${origins[@]}"; do
    echo ""
    if test_cors_preflight "$endpoint" "$origin" "POST"; then
      ((passed++))
    else
      ((failed++))
    fi
  done

  # Summary
  print_header "Batch Test Summary"
  echo -e "Total tests: ${BOLD}${#origins[@]}${NC}"
  echo -e "Passed: ${GREEN}${passed}${NC}"
  echo -e "Failed: ${RED}${failed}${NC}"

  if [ "$failed" -eq 0 ]; then
    print_success "${BOLD}All tests passed!${NC}"
    return 0
  else
    print_error "${BOLD}Some tests failed${NC}"
    return 1
  fi
}

# Function to run full test suite
run_full_test() {
  print_header "Full CORS Test Suite"

  # Define test combinations
  local regions=(
    "https://eu.onetimesecret.com"
    "https://ca.onetimesecret.com"
    "https://us.onetimesecret.com"
    "https://nz.onetimesecret.com"
  )

  local origins=(
    "https://onetimesecret.com"
    "https://www.onetimesecret.com"
    "http://localhost:4321"
  )

  local endpoint_path="/api/v2/secret/conceal"

  local total_tests=$((${#regions[@]} * ${#origins[@]}))
  local passed=0
  local failed=0
  local current=0

  print_info "Running ${total_tests} tests across ${#regions[@]} regions and ${#origins[@]} origins"

  for region in "${regions[@]}"; do
    local endpoint="${region}${endpoint_path}"

    for origin in "${origins[@]}"; do
      ((current++))
      echo ""
      print_subheader "[${current}/${total_tests}] Testing: ${region##*/} with origin: ${origin##*/}"

      if test_cors_preflight "$endpoint" "$origin" "POST" > /dev/null 2>&1; then
        ((passed++))
        print_success "Test passed"
      else
        ((failed++))
        print_error "Test failed"
      fi
    done
  done

  # Final summary
  print_header "Full Test Suite Summary"
  echo -e "Total tests: ${BOLD}${total_tests}${NC}"
  echo -e "Passed: ${GREEN}${passed}${NC}"
  echo -e "Failed: ${RED}${failed}${NC}"

  if [ "$failed" -eq 0 ]; then
    print_success "${BOLD}All tests passed!${NC}"
    return 0
  else
    print_error "${BOLD}${failed} test(s) failed${NC}"
    return 1
  fi
}

# Main script logic
main() {
  if [ $# -eq 0 ]; then
    usage
  fi

  case "${1:-}" in
    --help|-h)
      usage
      ;;
    --full)
      run_full_test
      ;;
    --batch)
      if [ $# -lt 3 ]; then
        echo -e "${RED}Error:${NC} --batch requires at least an endpoint and one origin"
        echo "Usage: test-cors --batch <endpoint> <origin1> [origin2] ..."
        exit 1
      fi
      shift
      local endpoint="$1"
      shift
      run_batch_test "$endpoint" "$@"
      ;;
    *)
      if [ $# -lt 2 ]; then
        echo -e "${RED}Error:${NC} Missing required arguments"
        echo "Usage: test-cors <endpoint> <origin> [method]"
        exit 1
      fi

      local endpoint="$1"
      local origin="$2"
      local method="${3:-$DEFAULT_METHOD}"

      # Run both preflight and actual request tests
      test_cors_preflight "$endpoint" "$origin" "$method"
      echo ""
      test_cors_request "$endpoint" "$origin" "$method"
      ;;
  esac
}

# Run main function
main "$@"
