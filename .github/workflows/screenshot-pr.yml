name: PR Screenshot

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  screenshot:
    name: Capture Homepage Screenshot
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.11

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build site
        run: pnpm build

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Start preview server
        run: pnpm preview --host &
        env:
          CI: true

      - name: Wait for server
        run: |
          echo "Waiting for server to be ready..."
          timeout 20 bash -c 'until curl -s http://localhost:4321 > /dev/null; do echo "Server not ready yet..."; sleep 1; done'
          echo "Server is ready!"

      - name: Capture screenshot
        run: |
          cat > screenshot.mjs << 'EOF'
          import { chromium } from 'playwright';

          const browser = await chromium.launch();
          const context = await browser.newContext({
            viewport: { width: 1920, height: 1080 }
          });
          const page = await context.newPage();

          await page.goto('http://localhost:4321', { waitUntil: 'networkidle' });
          await page.screenshot({
            path: 'homepage-screenshot.png',
            fullPage: true
          });

          await browser.close();
          EOF
          node screenshot.mjs

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: homepage-screenshot
          path: homepage-screenshot.png
          retention-days: 14

      - name: Comment on PR with screenshot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Check if screenshot exists
            if (!fs.existsSync('homepage-screenshot.png')) {
              console.log('Screenshot not found');
              return;
            }

            // Get the run ID and construct artifact URL
            const runId = context.runId;
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            // Create comment with screenshot info
            const comment = `## ðŸ“¸ Homepage Screenshot

            A screenshot of the homepage has been captured for this PR.

            **Screenshot Details:**
            - Resolution: 1920x1080
            - Type: Full page screenshot
            - Browser: Chromium

            [ðŸ“¦ Download Screenshot Artifact](${artifactUrl})

            *Screenshot updated on every push to this PR*
            `;

            // Check if we already posted a comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“¸ Homepage Screenshot')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
