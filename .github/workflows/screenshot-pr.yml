name: PR Screenshot

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  screenshot:
    name: Capture Homepage Screenshot
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.11

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build site
        run: pnpm build

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Start preview server
        run: pnpm preview --host &
        env:
          CI: true

      - name: Wait for server
        run: |
          echo "Waiting for server to be ready..."
          timeout 20 bash -c 'until curl -s http://localhost:4321 > /dev/null; do echo "Server not ready yet..."; sleep 1; done'
          echo "Server is ready!"

      - name: Capture screenshot
        run: |
          mkdir -p .github/screenshots
          cat > screenshot.mjs << 'EOF'
          import { chromium } from 'playwright';

          const browser = await chromium.launch();
          const context = await browser.newContext({
            viewport: { width: 1920, height: 1080 }
          });
          const page = await context.newPage();

          await page.goto('http://localhost:4321', { waitUntil: 'networkidle' });
          await page.screenshot({
            path: '.github/screenshots/pr-${{ github.event.pull_request.number }}.png',
            fullPage: true
          });

          await browser.close();
          EOF
          node screenshot.mjs

      - name: Commit and push screenshot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/screenshots/pr-${{ github.event.pull_request.number }}.png
          git diff --staged --quiet || git commit -m "Update screenshot for PR #${{ github.event.pull_request.number }}"
          git push

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: homepage-screenshot
          path: .github/screenshots/pr-${{ github.event.pull_request.number }}.png
          retention-days: 14

      - name: Comment on PR with screenshot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = context.issue.number;
            const branch = context.payload.pull_request.head.ref;
            const screenshotPath = `.github/screenshots/pr-${prNumber}.png`;

            if (!fs.existsSync(screenshotPath)) {
              console.log('Screenshot not found');
              return;
            }

            const screenshotUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/${branch}/${screenshotPath}`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const comment = [
              '<!-- screenshot-workflow-comment -->',
              '## ðŸ“¸ Homepage Screenshot',
              '',
              `![Homepage Screenshot](${screenshotUrl})`,
              '',
              '**Screenshot Details:**',
              '- Resolution: 1920x1080',
              '- Type: Full page screenshot',
              '- Browser: Chromium',
              `- [View Workflow Run](${runUrl})`,
              '',
              '*Screenshot updated on every push to this PR*'
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('<!-- screenshot-workflow-comment -->')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
